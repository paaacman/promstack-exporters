server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /promtail/positions.yaml

clients:
  - url: ${LOKI_EXTERNAL_URL}
    tenant_id: "promtail_${HOST_NAME}"
    basic_auth:
      username: ${LOKI_USERNAME}
      password: ${LOKI_PASSWORD}

scrape_configs:
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          __path__: /var/log/**/*log
          host: ${HOST_NAME}
          env: ${ENV}
    pipeline_stages:
      - match:
          selector: '{filename=~"/var/log/nginx/access.*.log"}'
          stages:
            - regex:
                expression: '^(?P<remote_addr>[\w\.]+) - (?P<remote_user>[^ ]*) \[(?P<time_local>.*)\] "(?P<method>[^ ]*) (?P<request_url>[^ ]*) (?P<request_http_protocol>[^ ]*)" (?P<status>[\d]+) (?P<body_bytes_sent>[\d]+) "(?P<http_referer>[^"]*)" "(?P<http_user_agent>[^"]*)"?'
            - labels:
                remote_addr:
                remote_user:
                time_local:
                method:
                request_url:
                request_http_protocol:
                status:
                body_bytes_sent:
                http_referer:
                http_user_agent:

  - job_name: logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: applogs
          __path__: /app/log/**/*.log
          host: ${HOST_NAME}
          env: ${ENV}
    pipeline_stages:
      - match:
          selector: '${APP_LOG_SELECTOR}'
          stages:
            - regex:
                expression: '${APP_MATCH_REGEX}'
            - labels: ${APP_MATCH_LABELS}
            #- json:
            #    expressions:
            #      user:
            #    source: body_params
